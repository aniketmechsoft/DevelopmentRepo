name: Debug PR Comment Event

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  debug-event:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Dump the raw GitHub event payload
      - name: Dump raw event payload
        run: |
          echo "Event JSON path: $GITHUB_EVENT_PATH"
          cat $GITHUB_EVENT_PATH | jq .

      # Step 2: Dump context.event safely
      - name: Dump full context
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("Event name:", context.event_name || "undefined");
            console.log("Full context.event:");
            console.log(JSON.stringify(context.event, null, 2));

      # Step 3: Try to extract PR info safely
      - name: Extract PR number and commit SHA
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eventName = context.event_name || "unknown";
            const commentBody = context.event?.comment?.body || "No comment body";

            console.log("Event name:", eventName);
            console.log("Comment body:", commentBody);

            if (!context.event?.issue?.pull_request) {
              console.log("Comment is not on a PR or missing PR info. Skipping PR extraction.");
              return { pr_number: null, commit_sha: null };
            }

            const pr_number = context.event.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            const commit_sha = pr.head.sha;

            console.log("PR number:", pr_number);
            console.log("Commit SHA:", commit_sha);

            return { pr_number, commit_sha };

      # Step 4: Extract suite from comment (optional)
      - name: Extract suite from comment
        id: suite
        run: |
          COMMENT="${{ github.event.comment.body || '' }}"
          SUITE=$(echo "$COMMENT" | awk '{print $2}' | tr '[:upper:]' '[:lower:]')
          echo "suite=$SUITE" >> $GITHUB_OUTPUT
          echo "Extracted suite: $SUITE"

      # Step 5: Log all outputs
      - name: Log outputs
        run: |
          echo "PR Number: ${{ steps.pr_info.outputs.pr_number }}"
          echo "Commit SHA: ${{ steps.pr_info.outputs.commit_sha }}"
          echo "Suite: ${{ steps.suite.outputs.suite }}"
