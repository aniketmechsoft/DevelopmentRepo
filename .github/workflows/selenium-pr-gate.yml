name: Selenium PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

  issue_comment:
    types: [created]

jobs:
  pr-open-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Set selenium-suite to pending
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'pending',
              context: 'selenium-suite',
              description: 'Waiting for admin to run Selenium suite'
            });

  pr-comment-dispatch:
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/run ')
    runs-on: ubuntu-latest
    steps:
      - name: Extract suite
        id: suite
        run: |
          SUITE=$(echo "${{ github.event.comment.body }}" | cut -d' ' -f2)
          echo "suite=$SUITE" >> $GITHUB_OUTPUT

      - name: Dispatch to testing repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.QA_TRIGGER_TOKEN }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: 'aniketmechsoft',
              repo: 'GitActionTest',
              event_type: 'run-selenium',
              client_payload: {
                suite: '${{ steps.suite.outputs.suite }}',
                pr: ${{ github.event.issue.number }}
              }
            });
