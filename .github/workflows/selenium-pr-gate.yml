name: Selenium PR Gate

on:
  pull_request:
    branches:
      - DEV

  issue_comment:
    types: [created]

jobs:
  # 1️⃣ PR opened → set status to pending
  pr-open-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Set Selenium status to pending
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: "pending",
              context: "selenium-suite",
              description: "Waiting for admin to run Selenium suite"
            });

  # 2️⃣ Admin comment → detect command → dispatch
  pr-comment-dispatch:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      # Detect suite command
      - name: Detect suite command
        id: detect
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" == "/run regression" ]]; then
            echo "suite=regression" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == "/run smoke" ]]; then
            echo "suite=smoke" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == "/run sanity" ]]; then
            echo "suite=sanity" >> $GITHUB_OUTPUT
          else
            echo "No valid command"
            exit 0
          fi

      # Fetch PR details (SHA + repo)
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = context.payload.issue.pull_request.url;
            const pr = await github.request(prUrl);
            core.setOutput("sha", pr.data.head.sha);
            core.setOutput("repo", pr.data.head.repo.full_name);

      # Reset status to pending (for re-runs)
      - name: Set Selenium status to pending (re-run)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: "pending",
              context: "selenium-suite",
              description: "Selenium suite running"
            });

      # Dispatch to testing repo
      - name: Dispatch to testing repo
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TESTING_REPO_PAT }}
          repository: aniketmechsoft/GitActionTest
          event-type: run-selenium
          client-payload: |
            {
              "suite": "${{ steps.detect.outputs.suite }}",
              "sha": "${{ steps.pr.outputs.sha }}",
              "repo": "${{ steps.pr.outputs.repo }}"
            }
