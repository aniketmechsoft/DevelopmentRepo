name: Selenium PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  # Job 1: Set PR status to pending (for PR events)
  pr-open-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Set selenium-suite to pending
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'pending',
              context: 'selenium-suite',
              description: 'Waiting for admin to run Selenium suite'
            });

  # Job 2: Respond to /run <suite> comments
  pr-comment-dispatch:
    if: github.event_name == 'issue_comment'   # only check event type here
    runs-on: ubuntu-latest
    steps:
      # Step 1: Debug comment and PR info safely
      - name: Debug PR info safely
        uses: actions/github-script@v7
        id: pr_info
        with:
          github-token: ${{ secrets.QA_TRIGGER_TOKEN }}
          script: |
            console.log("Event name:", context.event_name);
            console.log("Comment body:", context.event.comment?.body || "No comment body");

            // Check if this comment is on a PR
            if (!context.event.issue || !context.event.issue.pull_request) {
              console.log("Comment is not on a PR. Exiting workflow step.");
              return { pr_number: null, commit_sha: null };
            }

            const pr_number = context.event.issue.number;

            // Fetch PR info safely
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            const commit_sha = pr.head.sha;

            console.log("PR number:", pr_number);
            console.log("Commit SHA:", commit_sha);

            return { pr_number, commit_sha };

      # Step 2: Extract suite from comment safely
      - name: Extract suite
        id: suite
        run: |
          COMMENT="${{ github.event.comment.body }}"
          SUITE=$(echo "$COMMENT" | awk '{print $2}' | tr '[:upper:]' '[:lower:]')
          echo "suite=$SUITE" >> $GITHUB_OUTPUT
          echo "Extracted suite: $SUITE"

      # Step 3: Dispatch to testing repo (if PR info exists)
      - name: Dispatch to testing repo
        if: steps.pr_info.outputs.pr_number != null
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.QA_TRIGGER_TOKEN }}
          script: |
            console.log("Dispatching suite to testing repo...");
            await github.rest.repos.createDispatchEvent({
              owner: 'aniketmechsoft',
              repo: 'GitActionTest',
              event_type: 'run-selenium',
              client_payload: {
                suite: '${{ steps.suite.outputs.suite }}',
                pr_number: ${{ steps.pr_info.outputs.pr_number }},
                commit_sha: '${{ steps.pr_info.outputs.commit_sha }}'
              }
            });
            console.log("Dispatch complete.");
