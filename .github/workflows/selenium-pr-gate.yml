name: PR Regression Trigger

on:
  pull_request:
    branches: [dev]
  issue_comment:
    types: [created]

jobs:
  set-pending-on-pr-open:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Set regression status to pending
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -d '{
              "state": "pending",
              "context": "regression-tests",
              "description": "Waiting for admin to trigger regression"
            }'

  trigger-regression:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run regression') &&
      contains(fromJson('["OWNER","MEMBER"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest

    steps:
      - name: Set regression status to pending
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            -d '{
              "state": "pending",
              "context": "regression-tests",
              "description": "Regression tests running"
            }'

      - name: Trigger testing repository
        env:
          TOKEN: ${{ secrets.QA_TRIGGER_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/aniketmechsoft/GitActionTest/dispatches \
            -d '{
              "event_type": "run-regression",
              "client_payload": {
                "repo": "${{ github.repository }}",
                "sha": "${{ github.event.pull_request.head.sha }}"
              }
            }'
