name: PR Comment Trigger Tests

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  statuses: write

jobs:
  pr-comment-dispatch:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Debug (optional but recommended)
      - name: Debug event
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Comment: '${{ github.event.comment.body }}'"
          echo "Author: ${{ github.event.comment.author_association }}'"

      # 2Ô∏è‚É£ Detect command
      - name: Detect command
        id: detect
        run: |
          COMMENT="${{ github.event.comment.body }}"

          if [[ "$COMMENT" == "/run-tests" ]]; then
            echo "action=dispatch" >> $GITHUB_OUTPUT
          else
            echo "action=ignore" >> $GITHUB_OUTPUT
          fi

      # 3Ô∏è‚É£ Fetch PR details (CRITICAL)
      - name: Get PR info
        id: pr
        if: steps.detect.outputs.action == 'dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput("sha", pr.head.sha);
            core.setOutput("ref", pr.head.ref);

      # 4Ô∏è‚É£ Set commit status to pending
      - name: Set Selenium status to pending
        if: steps.detect.outputs.action == 'dispatch'
        uses: actions/github-script@v7
        env:
          PR_SHA: ${{ steps.pr.outputs.sha }}
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.PR_SHA,
              state: "pending",
              context: "selenium-suite",
              description: "üîÑ Selenium tests running..."
            });

      # 5Ô∏è‚É£ Dispatch test repository workflow
      - name: Dispatch test repo workflow
        if: steps.detect.outputs.action == 'dispatch'
        env:
          TOKEN: ${{ secrets.TEST_REPO_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/aniketmechsoft/GitActionTest/dispatches \
            -d '{
              "event_type": "run-tests",
              "client_payload": {
                "pr_number": "${{ github.event.issue.number }}",
                "sha": "${{ steps.pr.outputs.sha }}"
              }
            }'
