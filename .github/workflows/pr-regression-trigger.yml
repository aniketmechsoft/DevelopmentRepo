name: Selenium PR Gate

on:
  pull_request:
    branches:
      - DEV
    types: [opened, synchronize, reopened]

  issue_comment:
    types: [created]

permissions:
  contents: read
  statuses: write
  pull-requests: write
  issues: write

jobs:
  # 1ï¸âƒ£ PR opened â†’ set status to PENDING
  pr-open-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Set Selenium status to pending
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.payload.pull_request.head.repo.owner.login;
            const repo = context.payload.pull_request.head.repo.name;
            const sha = context.payload.pull_request.head.sha;

            try {
              await github.rest.repos.createCommitStatus({
                owner,
                repo,
                sha,
                state: "pending",
                context: "selenium-suite-gitapp",
                description: "â³ Awaiting admin command: /run [suite]"
              });
            } catch (e) {
              console.log("Status failed (fork). Posting comment.");

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: "â³ **Selenium tests awaiting admin command**\n\nUse `/run smoke1`, `/run regression1`, `/run sanity1`, or `/run no-run`."
              });
            }

  # 2ï¸âƒ£ Handle /run commands
  pr-comment-dispatch:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      github.event.comment.user.type != 'Bot' &&
      startsWith(github.event.comment.body, '/run ') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest

    steps:
      # ğŸ” Detect command
      - name: Detect suite command
        id: detect
        run: |
          COMMENT="${{ github.event.comment.body }}"

          if [[ "$COMMENT" == "/run regression1" ]]; then
            echo "suite=regression1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == "/run smoke1" ]]; then
            echo "suite=smoke1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == "/run sanity1" ]]; then
            echo "suite=sanity1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == "/run no-run" ]]; then
            echo "action=pass" >> $GITHUB_OUTPUT
          else
            echo "action=invalid" >> $GITHUB_OUTPUT
          fi

      # âŒ Invalid command
      - name: Invalid command comment
        if: steps.detect.outputs.action == 'invalid'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âŒ **Invalid command**\n\nValid commands:\n- `/run smoke1`\n- `/run regression1`\n- `/run sanity1`\n- `/run no-run`"
            });

      # ğŸ“Œ Fetch PR details
      - name: Get PR details
        if: steps.detect.outputs.action != 'invalid'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput("sha", pr.data.head.sha);
            core.setOutput("head_repo_owner", pr.data.head.repo.owner.login);
            core.setOutput("head_repo_name", pr.data.head.repo.name);
            core.setOutput("branch", pr.data.head.ref);
            core.setOutput("pr_number", context.issue.number);

      # ğŸ” IMPORTANT: Force-reset status to PENDING for real suites
      - name: Acknowledge suite & block merge
        if: steps.detect.outputs.action == 'dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = "${{ steps.pr.outputs.head_repo_owner }}";
            const repo = "${{ steps.pr.outputs.head_repo_name }}";
            const sha = "${{ steps.pr.outputs.sha }}";

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: "pending",
              context: "selenium-suite-gitapp",
              description: "Running ${{ steps.detect.outputs.suite }} tests..."
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ğŸš€ **${{ steps.detect.outputs.suite }}** tests started.\n\nâ›” Merge blocked until tests finish."
            });

      # ğŸš€ Dispatch tests
      - name: Dispatch to testing repo
        if: steps.detect.outputs.action == 'dispatch'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TEST_REPO_TOKEN }}
          repository: aniketmechsoft/GitActionTest
          event-type: run-selenium
          client-payload: |
            {
              "suite": "${{ steps.detect.outputs.suite }}",
              "sha": "${{ steps.pr.outputs.sha }}",
              "pr_number": "${{ steps.pr.outputs.pr_number }}",
              "branch": "${{ steps.pr.outputs.branch }}",
              "head_repo_owner": "${{ steps.pr.outputs.head_repo_owner }}",
              "head_repo_name": "${{ steps.pr.outputs.head_repo_name }}"
            }

      # âš ï¸ Admin override
      - name: Mark Selenium as success (no-run)
        if: steps.detect.outputs.action == 'pass'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = "${{ steps.pr.outputs.head_repo_owner }}";
            const repo = "${{ steps.pr.outputs.head_repo_name }}";
            const sha = "${{ steps.pr.outputs.sha }}";

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: "success",
              context: "selenium-suite-gitapp",
              description: "âš ï¸ Tests skipped by admin override"
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âš ï¸ **Selenium tests skipped by admin override**\n\nMerge unblocked."
            });
