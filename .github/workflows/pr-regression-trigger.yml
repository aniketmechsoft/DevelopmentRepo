name: Selenium PR Gate

on:
  pull_request:
    branches:
      - DEV
  issue_comment:
    types: [created]

jobs:
  # 1Ô∏è‚É£ PR opened ‚Üí set pending status
  pr-open-pending:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Set Selenium status to pending
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: "pending",
              context: "selenium-suite",
              description: "‚è≥ Awaiting admin command - see PR comment for instructions"
            });
      
      - name: Post instructions comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üß™ Selenium Test Suite')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## üß™ Selenium Test Suite
            
            This PR requires Selenium testing before merge.
            
            ### üìã Available Commands (Admin/Member only):
            
            | Command | Description | Duration |
            |---------|-------------|----------|
            | \`/run smoke1\` | Quick smoke tests | ~5-10 min |
            | \`/run sanity1\` | Sanity checks | ~10-15 min |
            | \`/run regression1\` | Full regression suite | ~30-60 min |
            | \`/run no-run\` | Skip tests (admin override) | Instant |
            
            ### üéØ How to Run:
            
            1. **Post a comment** with one of the commands above
            2. Wait for the test suite to complete
            3. Check the status and results
            4. Merge when tests pass ‚úÖ
            
            ### üí° Tips:
            
            - Start with \`/run smoke1\` for quick feedback
            - Use \`/run regression1\` before final merge
            - You can re-run tests anytime by posting the command again
            - **Note:** Only repository admins/members can trigger tests
            
            ---
            *Status will update automatically when tests complete*`
              });
            }

  # 2Ô∏è‚É£ Admin comment ‚Üí decide action
  pr-comment-dispatch:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      (github.event.comment.author_association == 'OWNER' || 
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    steps:
      - name: Detect suite command
        id: detect
        run: |
          COMMENT="${{ github.event.comment.body }}"
          
          if [[ "$COMMENT" =~ ^/run\ regression1$ ]]; then
            echo "suite=regression1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
            echo "description=Full regression suite" >> $GITHUB_OUTPUT
            echo "duration=30-60 min" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" =~ ^/run\ smoke1$ ]]; then
            echo "suite=smoke1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
            echo "description=Quick smoke tests" >> $GITHUB_OUTPUT
            echo "duration=5-10 min" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" =~ ^/run\ sanity1$ ]]; then
            echo "suite=sanity1" >> $GITHUB_OUTPUT
            echo "action=dispatch" >> $GITHUB_OUTPUT
            echo "description=Sanity checks" >> $GITHUB_OUTPUT
            echo "duration=10-15 min" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" =~ ^/run\ no-run$ ]]; then
            echo "action=pass" >> $GITHUB_OUTPUT
          else
            echo "action=invalid" >> $GITHUB_OUTPUT
          fi

      - name: Comment on invalid command
        if: steps.detect.outputs.action == 'invalid'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå **Invalid command!**
            
            Please use one of these commands:
            
            | Command | Description |
            |---------|-------------|
            | \`/run smoke1\` | Quick smoke tests (~5-10 min) |
            | \`/run sanity1\` | Sanity checks (~10-15 min) |
            | \`/run regression1\` | Full regression suite (~30-60 min) |
            | \`/run no-run\` | Skip tests (admin override) |
            
            üí° **Tip:** Just post a new comment with the exact command`
            });

      - name: Get PR details
        if: steps.detect.outputs.action != 'invalid'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput("sha", pr.data.head.sha);
            core.setOutput("repo", pr.data.head.repo.full_name);
            core.setOutput("pr_number", context.issue.number);
            core.setOutput("branch", pr.data.head.ref);

      - name: Acknowledge test dispatch
        if: steps.detect.outputs.action == 'dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const suite = '${{ steps.detect.outputs.suite }}';
            const description = '${{ steps.detect.outputs.description }}';
            const duration = '${{ steps.detect.outputs.duration }}';
            const author = context.payload.comment.user.login;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üöÄ **Test suite dispatched by @${author}**
            
            **Suite:** ${suite}
            **Type:** ${description}
            **Est. Duration:** ${duration}
            
            ‚è≥ Tests are running... Status will update automatically.
            
            [View test progress ‚Üí](https://github.com/aniketmechsoft/GitActionTest/actions)
            
            ---
            *You can monitor progress in the testing repository*`
            });

      - name: Set Selenium status to pending (rerun)
        if: steps.detect.outputs.action == 'dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: "pending",
              context: "selenium-suite",
              description: "üîÑ Running ${{ steps.detect.outputs.suite }} tests... (est. ${{ steps.detect.outputs.duration }})"
            });

      - name: Directly mark Selenium as success (no-run)
        if: steps.detect.outputs.action == 'pass'
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.comment.user.login;
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: "success",
              context: "selenium-suite",
              description: "‚ö†Ô∏è Tests skipped by admin override (@${author})"
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è **Selenium tests skipped by @${author}**
            
            Tests have been bypassed with admin override.
            Manual review is required before merge.
            
            ‚úÖ PR is now **eligible for merge** (pending other checks)`
            });

      # üöÄ Dispatch to testing repo
      - name: Dispatch to testing repo
        if: steps.detect.outputs.action == 'dispatch'
        id: dispatch
        continue-on-error: true  # üëà DON'T fail the job if dispatch fails
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TEST_REPO_TOKEN }}
          repository: aniketmechsoft/GitActionTest
          event-type: run-selenium
          client-payload: |
            {
              "suite": "${{ steps.detect.outputs.suite }}",
              "sha": "${{ steps.pr.outputs.sha }}",
              "repo": "${{ steps.pr.outputs.repo }}",
              "pr_number": "${{ steps.pr.outputs.pr_number }}",
              "branch": "${{ steps.pr.outputs.branch }}",
              "dev_repo_owner": "${{ github.repository_owner }}",
              "dev_repo_name": "${{ github.event.repository.name }}"
            }

      # ‚ùå NEW: Handle dispatch failure
      - name: Handle dispatch failure
        if: steps.detect.outputs.action == 'dispatch' && steps.dispatch.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const suite = '${{ steps.detect.outputs.suite }}';
            
            // Set status to failure
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: "failure",
              context: "selenium-suite",
              description: "‚ùå Failed to dispatch tests to testing repo"
            });
            
            // Comment about the failure
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå **Failed to dispatch ${suite} tests to testing repository**
            
            **Error:** Unable to trigger the testing workflow.
            
            **Possible causes:**
            - Testing repository is unavailable
            - Token (\`TEST_REPO_TOKEN\`) is invalid or expired
            - Network connectivity issue
            
            **What to do:**
            1. Check [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Verify the testing repository is accessible
            3. Contact repository administrator if issue persists
            4. Try again with: \`/run ${suite}\`
            
            **Admin actions:**
            - Verify \`TEST_REPO_TOKEN\` secret is valid
            - Check testing repo: https://github.com/aniketmechsoft/GitActionTest`
            });

      # ‚úÖ NEW: Confirm dispatch success
      - name: Confirm dispatch success
        if: steps.detect.outputs.action == 'dispatch' && steps.dispatch.outcome == 'success'
        run: |
          echo "‚úÖ Successfully dispatched ${{ steps.detect.outputs.suite }} tests to testing repo"
          echo "Waiting for testing repo to report back..."
